language: java
sudo: false
services:
  - mongodb
jdk:
  - openjdk11
cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.sonar/cache'
script:
  - mvn clean package
notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/e2b5f5d5c337a7af9276
    on_success: change
    on_failure: always
    on_start: never
  irc:
    - irc.freenode.org#jrds
addons:
  sonarcloud:
    organization: rrd4j
    token:
      secure: "jQYJJtZwMLL584h/D3DMyF/N2GUHVucEAsH6EbvlPPhEkArZh97/HFOMLJhqxi/RRndpd0fVIUqwToIBfYepnkgZlsbLEVFztZoFqIWygCOu1rbTXVpU0mTX/dsxxzPyyJI3YhmvWQpwuKQrSk8DL9RUOr6niSbr9wgloPIPgtQ="
matrix:
  include:
      # Sonarcloud don't work on jdk11 yet
      # See https://github.com/SonarSource/sonar-scanner-maven/pull/47
    - jdk: openjdk8
      script:
        - mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent package sonar:sonar deploy --settings deploy-settings.xml
      on:
          branch: master
      # Target openjdk7 needs to be build with opendjk11 because of bnd-maven-plugin
    - name: "openjdk7"
      jdk: openjdk11
      script:
        - mvn clean verify site -Dmaven.test.skip=true -Djdk.home=/usr/lib/jvm/java-7-openjdk-amd64 && JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64 mvn test -Dmaven.main.skip -Djdk.home=/usr/lib/jvm/java-7-openjdk-amd64
